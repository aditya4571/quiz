<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADITYA AI Quiz Generator - Pro randomized</title>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dark Mode Defaults */
      --primary: #6366f1;
      --primary-hover: #818cf8;
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --success: #22c55e;
      --error: #ef4444;
      --border: #334155;
      --radius: 10px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      --watermark-color: rgba(255, 255, 255, 0.1);
    }

    body.light-mode {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --watermark-color: rgba(0, 0, 0, 0.15);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      line-height: 1.4;
      padding: 10px;
      transition: background-color 0.3s, color 0.3s;
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
    }

    /* Responsive Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-left h1 {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: -0.025em;
      text-transform: uppercase;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 500;
    }

    .theme-toggle {
      background: var(--border);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      color: var(--text-main);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Collapsible Upload Card */
    .upload-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 15px;
      overflow: hidden;
    }

    .upload-card-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.05);
      transition: background 0.2s;
    }

    .upload-card-header h2 {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-main);
      text-transform: uppercase;
    }

    .upload-card.collapsed .upload-card-content { display: none; }
    .toggle-icon { font-size: 0.7rem; transition: transform 0.3s; }
    .upload-card.collapsed .toggle-icon { transform: rotate(-90deg); }

    .upload-card-content { padding: 15px; }

    .input-tabs {
      display: inline-flex;
      background: var(--bg);
      padding: 3px;
      border-radius: 8px;
      margin-bottom: 15px;
      width: 100%;
      justify-content: center;
    }

    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 8px 5px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.7rem;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: var(--card-bg);
      color: var(--primary);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Responsive Settings Grid */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    @media (max-width: 768px) {
      .settings-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 480px) {
      .settings-grid { grid-template-columns: 1fr; }
    }

    .input-group { display: flex; flex-direction: column; gap: 4px; }
    .input-label { font-size: 0.65rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

    .input-field {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      outline: none;
      background: var(--bg);
      color: var(--text-main);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-main);
      cursor: pointer;
      padding: 5px 0;
    }

    .checkbox-group input { width: 16px; height: 16px; cursor: pointer; }

    .file-input-wrapper {
      border: 1px dashed var(--border);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      background: var(--bg);
    }

    .paste-area {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      resize: vertical;
      margin-bottom: 10px;
      background: var(--bg);
      color: var(--text-main);
      outline: none;
    }

    #fileInput, #aiFileInput { display: none; }

    .btn-upload, .btn-action {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 0.8rem;
      gap: 6px;
      width: 100%;
    }

    .btn-upload:hover { background: var(--primary-hover); }
    .btn-print { background: #475569; width: auto; }
    .btn-jumble { background: #0ea5e9; width: auto; }
    .btn-reveal { background: #f59e0b; width: auto; }
    .btn-review { background: #ef4444; width: auto; }
    .btn-clear { background: #94a3b8; margin-top: 10px; color: #000; width: 100%; }

    /* Stats Bar (Responsive) */
    .stats-bar {
      display: none;
      justify-content: space-between;
      align-items: center;
      background: var(--card-bg);
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: sticky;
      top: 10px;
      z-index: 100;
      flex-wrap: wrap;
      gap: 10px;
    }

    .stat-item { font-weight: 700; font-size: 0.85rem; }

    /* Floating Timer */
    #floatingTimer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card-bg);
      border: 1px solid var(--primary);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
      z-index: 10000;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 130px;
      animation: slideUp 0.3s ease;
    }

    .timer-display { font-size: 1.3rem; font-weight: 800; color: var(--primary); font-family: monospace; }
    .timer-controls { display: flex; gap: 8px; }
    .timer-btn {
      background: var(--border);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      color: var(--text-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    /* Grid Layout for Questions (Responsive) */
    .page-container {
      position: relative;
      margin-bottom: 25px;
      width: 100%;
    }

    .quiz-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 1fr;
      gap: 15px;
    }

    /* Mobile Question Stack */
    @media (max-width: 768px) {
      .quiz-grid { grid-template-columns: 1fr; grid-auto-rows: auto; }
      #floatingTimer { right: 10px; bottom: 10px; padding: 10px; min-width: 110px; }
      .timer-display { font-size: 1.1rem; }
    }

    .question-card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 160px;
    }

    h3 { font-size: 0.9rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }

    .option-label {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: var(--text-main);
      transition: all 0.2s;
      position: relative;
    }

    .option-label:hover:not(.disabled) { background: var(--bg); border-color: var(--primary); }

    .option-label input { margin-right: 12px; width: 16px; height: 16px; flex-shrink: 0; }

    .option-label.correct-choice { background-color: #dcfce7 !important; border-color: var(--success) !important; color: #166534 !important; font-weight: 600; }
    .option-label.incorrect-choice { background-color: #fee2e2 !important; border-color: var(--error) !important; color: #991b1b !important; font-weight: 600; }

    .feedback-icon {
      margin-left: auto;
      font-weight: 800;
      font-size: 1rem;
    }

    /* Progress UI */
    .progress-container { width: 100%; background: var(--border); border-radius: 99px; height: 6px; margin: 10px 0; overflow: hidden; }
    .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease; }

    /* Watermark Over Cards */
    .page-watermark {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: clamp(60px, 15vw, 110px);
      font-weight: 900;
      color: var(--watermark-color);
      white-space: nowrap;
      pointer-events: none;
      z-index: 9999;
      text-transform: uppercase;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    @page { size: A4; margin: 0; }

    @media print {
      body { background: white !important; padding: 0 !important; color: #000 !important; }
      .upload-card, .stats-bar, header, .btn-clear, #floatingTimer { display: none !important; }
      
      .page-container { 
        page-break-after: always; 
        padding: 8mm !important; 
        height: 296mm; 
        width: 210mm; 
        position: relative; 
        overflow: hidden; 
      }
      
      .page-watermark { display: block !important; color: rgba(0, 0, 0, 0.12) !important; }
      
      .quiz-grid { 
        display: grid !important; 
        grid-template-columns: 1fr 1fr !important; 
        grid-template-rows: repeat(5, 1fr) !important; 
        height: 278mm !important; 
        gap: 5mm !important;
      }
      
      .question-card { 
        border: 0.5pt solid #000 !important; 
        padding: 6px !important; 
        height: 100% !important; 
        z-index: 5; 
        background: white !important; 
        box-shadow: none !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        overflow: hidden !important;
      }

      h3 { 
        font-size: 9pt !important; 
        margin-bottom: 4px !important; 
        color: #000 !important; 
        line-height: 1.2 !important;
      }
      
      .option-label { 
        border: 0.5pt solid #888 !important; 
        padding: 2px 5px !important; 
        font-size: 8pt !important; 
        margin-bottom: 2px !important; 
        color: #000 !important;
        border-radius: 3px !important;
      }

      * { color: #000 !important; border-color: #000 !important; }
    }

    /* PDF Specific State to Mirror Print */
    .pdf-render-state { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
    .pdf-render-state .page-container { page-break-after: always; height: 296mm; width: 210mm; padding: 8mm; }
    .pdf-render-state .page-watermark { display: block !important; color: rgba(0, 0, 0, 0.1) !important; }
    .pdf-render-state .quiz-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; grid-template-rows: repeat(5, 1fr) !important; height: 278mm !important; gap: 5mm !important; }
    .pdf-render-state .question-card { border: 1px solid #000 !important; background: white !important; padding: 6px !important; }
    .pdf-render-state h3 { font-size: 9pt !important; margin-bottom: 4px !important; line-height: 1.2 !important; }
    .pdf-render-state .option-label { font-size: 8pt !important; padding: 2px 5px !important; border: 1px solid #000 !important; margin-bottom: 2px !important; }
    .pdf-render-state * { color: #000 !important; }
  </style>
</head>
<body oncontextmenu="return false;">

  <div class="container" id="main-content">
    <header>
      <div class="header-left">
        <h1>ADITYA AI Quiz</h1>
        <span class="subtitle">Engineering MCQ Expert Author</span>
      </div>
      <button id="themeToggle" class="theme-toggle">
        <span id="themeIcon">‚òÄÔ∏è</span> <span id="themeText">Light Mode</span>
      </button>
    </header>
    
    <div class="upload-card" id="upload-section">
      <div class="upload-card-header" id="uploadCardToggle">
        <h2>Setup & Document Upload</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      
      <div class="upload-card-content" id="uploadCardContent">
        <div class="input-tabs">
          <button id="tab-ai" class="tab-btn active">AI Generation</button>
          <button id="tab-upload" class="tab-btn">Direct .docx</button>
          <button id="tab-paste" class="tab-btn">Paste Text</button>
        </div>

        <div id="ai-content" class="tab-content active">
          <div class="settings-grid">
            <div class="input-group">
              <label class="input-label">Gemini API Key</label>
              <input type="password" id="geminiApiKey" class="input-field" placeholder="Paste key..." />
            </div>
            <div class="input-group">
              <label class="input-label">MCQ Count</label>
              <input type="number" id="numQuestions" class="input-field" value="200" min="10" />
            </div>
            <div class="input-group">
              <label class="input-label">Shuffle Settings</label>
              <label class="checkbox-group">
                <input type="checkbox" id="jumbleQuestions" checked> Jumble Questions
              </label>
              <label class="checkbox-group">
                <input type="checkbox" id="jumbleOptions" checked> Jumble Options
              </label>
            </div>
          </div>
          <div class="file-input-wrapper">
            <label for="aiFileInput" class="btn-upload">Select Manual (PDF/Docx)</label>
            <input type="file" id="aiFileInput" accept=".pdf,.docx" />
          </div>
        </div>

        <div id="upload-content" class="tab-content">
          <div class="file-input-wrapper">
            <label for="fileInput" class="btn-upload">Upload Quiz .docx</label>
            <input type="file" id="fileInput" accept=".docx" />
          </div>
        </div>

        <div id="paste-content" class="tab-content">
          <textarea id="pasteInput" class="paste-area" placeholder="1. Question... **Correct Option**"></textarea>
          <button id="generateBtn" class="btn-upload">Process Text</button>
        </div>

        <div id="loadingStatus" style="display: none; text-align: center; margin-top: 15px;">
          <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
          <span id="loadingMessage" style="font-size: 0.75rem; font-weight: 600; color: var(--primary);">Processing...</span>
        </div>

        <button id="clearSessionBtn" class="btn-action btn-clear" style="display: none;">New Quiz (Clear Browser Data)</button>
      </div>
    </div>

    <div id="statsBar" class="stats-bar">
      <div class="stat-item" style="color: var(--primary);">Score: <span id="currentScore">0</span> / <span id="totalQuestionsCount">0</span></div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button id="revealAllBtn" class="btn-action btn-reveal">Reveal All</button>
        <button id="reviewErrorsBtn" class="btn-action btn-review">Review Errors</button>
        <button id="jumbleNowBtn" class="btn-action btn-jumble">Shuffle Quiz</button>
        <button id="printReviewBtn" class="btn-action btn-print">Print Review</button>
        <button onclick="window.print()" class="btn-action btn-print">Print All</button>
      </div>
    </div>

    <div id="quizContainer"></div>
  </div>

  <!-- Floating Timer -->
  <div id="floatingTimer">
    <div class="timer-display" id="timerValue">00:00:00</div>
    <div class="timer-controls">
      <button class="timer-btn" id="timerPlayPause">‚è∏</button>
      <button class="timer-btn" id="timerStop">‚èπ</button>
    </div>
  </div>

  <script>
    // --- PROTECTION ---
    document.onkeydown = function(e) {
      if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false;
    };
    setInterval(function() { (function() { return false; })['constructor']('debugger')(); }, 1000);

    // --- APP LOGIC ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let questions = [];
    let userAnswers = {}; 
    let score = 0;
    let timerInterval = null;
    let elapsedSeconds = 0;
    let isTimerRunning = false;
    let isReviewMode = false;

    const KEY_QUIZ = 'ADITYA_QUIZ_DATA';
    const KEY_ANSWERS = 'ADITYA_QUIZ_ANSWERS';
    const KEY_THEME = 'ADITYA_THEME';
    const KEY_TIMER = 'ADITYA_TIMER_VAL';

    // Fisher-Yates Shuffle
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function saveToBrowser() {
      localStorage.setItem(KEY_QUIZ, JSON.stringify(questions));
      localStorage.setItem(KEY_ANSWERS, JSON.stringify(userAnswers));
      localStorage.setItem(KEY_TIMER, elapsedSeconds.toString());
    }

    function loadFromBrowser() {
      const savedTheme = localStorage.getItem(KEY_THEME);
      if (savedTheme === 'light') { document.body.classList.add('light-mode'); updateThemeUI('light'); }
      const savedQuiz = localStorage.getItem(KEY_QUIZ);
      const savedAnswers = localStorage.getItem(KEY_ANSWERS);
      const savedTimer = localStorage.getItem(KEY_TIMER);
      if (savedQuiz) {
        questions = JSON.parse(savedQuiz);
        userAnswers = savedAnswers ? JSON.parse(savedAnswers) : {};
        elapsedSeconds = savedTimer ? parseInt(savedTimer) : 0;
        document.getElementById('statsBar').style.display = 'flex';
        document.getElementById('clearSessionBtn').style.display = 'block';
        document.getElementById('upload-section').classList.add('collapsed');
        renderQuiz(); applyStoredAnswers(); updateTimerDisplay();
        if (Object.keys(userAnswers).length > 0) document.getElementById('floatingTimer').style.display = 'flex';
      }
    }

    function switchTab(type) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`tab-${type}`).classList.add('active');
      document.getElementById(`${type}-content`).classList.add('active');
    }

    document.getElementById('uploadCardToggle').onclick = () => document.getElementById('upload-section').classList.toggle('collapsed');
    document.getElementById('themeToggle').onclick = () => {
      const isLight = document.body.classList.toggle('light-mode');
      localStorage.setItem(KEY_THEME, isLight ? 'light' : 'dark');
      updateThemeUI(isLight ? 'light' : 'dark');
    };
    function updateThemeUI(theme) {
      const icon = document.getElementById('themeIcon');
      const text = document.getElementById('themeText');
      if (theme === 'light') { icon.textContent = 'üåô'; text.textContent = 'Dark Mode'; } 
      else { icon.textContent = '‚òÄÔ∏è'; text.textContent = 'Light Mode'; }
    }

    function startTimer() {
      if (isTimerRunning) return;
      isTimerRunning = true;
      document.getElementById('floatingTimer').style.display = 'flex';
      document.getElementById('timerPlayPause').textContent = '‚è∏';
      timerInterval = setInterval(() => { elapsedSeconds++; updateTimerDisplay(); saveToBrowser(); }, 1000);
    }
    function pauseTimer() { isTimerRunning = false; clearInterval(timerInterval); document.getElementById('timerPlayPause').textContent = '‚ñ∂'; }
    function updateTimerDisplay() {
      const h = Math.floor(elapsedSeconds / 3600).toString().padStart(2, '0');
      const m = Math.floor((elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
      const s = (elapsedSeconds % 60).toString().padStart(2, '0');
      document.getElementById('timerValue').textContent = `${h}:${m}:${s}`;
    }
    document.getElementById('timerPlayPause').onclick = () => isTimerRunning ? pauseTimer() : startTimer();
    document.getElementById('timerStop').onclick = () => { if(confirm("Reset Timer?")) { pauseTimer(); elapsedSeconds = 0; updateTimerDisplay(); saveToBrowser(); } };

    async function extractPdfText(file) {
      const pdf = await pdfjsLib.getDocument({data: await file.arrayBuffer()}).promise;
      let fullText = "";
      const maxPages = Math.min(pdf.numPages, 100);
      for (let i = 1; i <= maxPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        fullText += content.items.map(item => item.str).join(' ') + "\n";
        showLoading(`Extracting (Page ${i}/${maxPages})...`, 10 + Math.floor((i/maxPages)*20));
      }
      return fullText;
    }

    async function callGemini(key, docText, count) {
      const prompt = `Role: Expert MCQ author. Task: From document, produce exactly ${count} MCQs. Format: Section: <Title> 1. <Question> A) Opt B) Opt **C) Correct** D) Opt`;
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
      const payload = { contents: [{ parts: [{ text: `${prompt}\n\nDOCUMENT:\n${docText.substring(0, 60000)}` }] }], generationConfig: { temperature: 0.1, maxOutputTokens: 8192 } };
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      return data.candidates[0].content.parts[0].text;
    }

    function showLoading(msg, percent = 0) {
      document.getElementById('loadingStatus').style.display = 'block';
      document.getElementById('loadingMessage').textContent = msg;
      document.getElementById('progressBar').style.width = percent + '%';
    }
    function hideLoading() { document.getElementById('loadingStatus').style.display = 'none'; }

    async function processRawText(text, shuffleQs = false, shuffleOpts = false) {
      const cleaned = text.replace(/^Section:.*$/gm, ''); 
      const blocks = cleaned.split(/\n(?=\d+\. )/g);
      let parsed = [];
      for (let block of blocks) {
        const lines = block.trim().split(/\n/);
        if (lines.length < 2) continue;
        const qLine = lines[0].replace(/^\d+\.\s*/, '').trim();
        const options = []; let answer = -1;
        for (let i = 1; i < lines.length; i++) {
          let line = lines[i].trim(); if (!line) continue;
          const isCorrect = line.includes('**');
          // Standard MCQ Match A-D or Numeric Match
          const match = line.replace(/\*\*/g, '').match(/^([A-D]|\d+)[)\.]\s*(.*)/i);
          if (match) { options.push(match[2].trim()); if (isCorrect) answer = options.length - 1; }
        }
        // Accept questions with 2 or more options (supports True/False)
        if (qLine && options.length >= 2 && answer !== -1) parsed.push({ q: qLine, options, answer });
      }

      if (parsed.length > 0) {
        if (shuffleQs) shuffleArray(parsed);
        if (shuffleOpts) {
          parsed.forEach(q => {
            const correctVal = q.options[q.answer];
            shuffleArray(q.options);
            q.answer = q.options.indexOf(correctVal);
          });
        }
        questions = parsed;
        userAnswers = {}; elapsedSeconds = 0;
        saveToBrowser(); renderQuiz();
        document.getElementById('statsBar').style.display = 'flex';
        document.getElementById('clearSessionBtn').style.display = 'block';
        document.getElementById('upload-section').classList.add('collapsed');
      } else alert("Format error. Please check your document.");
    }

    function renderQuiz(filterToWrong = false) {
      const container = document.getElementById('quizContainer');
      container.innerHTML = '';
      
      const displayQuestions = filterToWrong 
        ? questions.map((q, i) => ({...q, originalIndex: i})).filter((q, i) => userAnswers.hasOwnProperty(q.originalIndex) && userAnswers[q.originalIndex] !== q.answer && userAnswers[q.originalIndex] !== -1)
        : questions.map((q, i) => ({...q, originalIndex: i}));

      document.getElementById('totalQuestionsCount').textContent = questions.length;
      
      if (filterToWrong && displayQuestions.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--text-main);">No wrong answers found!</div>';
        return;
      }

      for (let i = 0; i < displayQuestions.length; i += 10) {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page-container';
        pageDiv.innerHTML = `<div class="page-watermark">ADITYA</div>`;
        const grid = document.createElement('div');
        grid.className = 'quiz-grid';

        for (let j = i; j < i + 10 && j < displayQuestions.length; j++) {
          const q = displayQuestions[j];
          const qIdx = q.originalIndex;
          const card = document.createElement('div');
          card.className = 'question-card';
          card.id = `q-card-${qIdx}`;
          card.innerHTML = `<h3>${qIdx + 1}. ${q.q}</h3><div class="options-list"></div>`;
          const list = card.querySelector('.options-list');
          q.options.forEach((opt, idx) => {
            const label = document.createElement('label');
            label.className = 'option-label';
            label.id = `label-${qIdx}-${idx}`;
            label.innerHTML = `<input type="radio" name="q${qIdx}" value="${idx}"> <span>${String.fromCharCode(65 + idx)}) ${opt}</span> <span class="feedback-icon" id="feedback-icon-${qIdx}-${idx}"></span>`;
            label.querySelector('input').onclick = () => handleSelection(qIdx, idx);
            list.appendChild(label);
          });
          grid.appendChild(card);
        }
        pageDiv.appendChild(grid);
        container.appendChild(pageDiv);
      }
      applyStoredAnswers();
    }

    function handleSelection(qIndex, selectedIndex) {
      if (userAnswers.hasOwnProperty(qIndex) && userAnswers[qIndex] !== -1) return;
      if (Object.keys(userAnswers).length === 0) startTimer();
      userAnswers[qIndex] = selectedIndex;
      saveToBrowser(); applyStoredAnswers();
    }

    function applyStoredAnswers() {
      score = 0;
      Object.keys(userAnswers).forEach(qKey => {
        const qIdx = parseInt(qKey), selIdx = userAnswers[qKey], qObj = questions[qIdx], card = document.getElementById(`q-card-${qIdx}`);
        if (!card) return;
        card.dataset.answered = "true";
        card.querySelectorAll('.option-label').forEach(l => {
          l.style.pointerEvents = 'none'; l.classList.add('disabled');
          const input = l.querySelector('input'); input.disabled = true;
          if (parseInt(input.value) === selIdx) input.checked = true;
        });

        card.querySelectorAll('.feedback-icon').forEach(icon => icon.textContent = '');
        const selLabel = document.getElementById(`label-${qIdx}-${selIdx}`), corrLabel = document.getElementById(`label-${qIdx}-${qObj.answer}`);
        const selIcon = document.getElementById(`feedback-icon-${qIdx}-${selIdx}`), corrIcon = document.getElementById(`feedback-icon-${qIdx}-${qObj.answer}`);

        if (selIdx === qObj.answer) {
          score++;
          if (selLabel) selLabel.classList.add('correct-choice');
          if (selIcon) selIcon.textContent = '‚úî';
        } else if (selIdx !== -1) {
          if (selLabel) selLabel.classList.add('incorrect-choice');
          if (selIcon) selIcon.textContent = '‚úñ';
          if (corrLabel) corrLabel.classList.add('correct-choice');
          if (corrIcon) corrIcon.textContent = '‚úî';
        } else {
          if (corrLabel) corrLabel.classList.add('correct-choice');
          if (corrIcon) corrIcon.textContent = '‚úî';
        }
      });
      document.getElementById('currentScore').textContent = score;
    }

    document.getElementById('revealAllBtn').onclick = () => {
      if(confirm("Reveal all correct answers?")) {
        questions.forEach((q, idx) => { if (!userAnswers.hasOwnProperty(idx)) userAnswers[idx] = -1; });
        saveToBrowser(); applyStoredAnswers();
      }
    };

    document.getElementById('reviewErrorsBtn').onclick = () => {
      isReviewMode = !isReviewMode;
      document.getElementById('reviewErrorsBtn').textContent = isReviewMode ? "Show All" : "Review Errors";
      renderQuiz(isReviewMode);
    };

    document.getElementById('printReviewBtn').onclick = () => {
      const originalMode = isReviewMode;
      isReviewMode = true;
      renderQuiz(true);
      setTimeout(() => {
        window.print();
        isReviewMode = originalMode;
        renderQuiz(originalMode);
      }, 500);
    };

    window.onload = loadFromBrowser;
    document.getElementById('tab-ai').onclick = () => switchTab('ai');
    document.getElementById('tab-upload').onclick = () => switchTab('upload');
    document.getElementById('tab-paste').onclick = () => switchTab('paste');
    document.getElementById('clearSessionBtn').onclick = () => { if(confirm("Clear current quiz and all progress?")) { localStorage.clear(); location.reload(); } };
    
    document.getElementById('jumbleNowBtn').onclick = () => {
      if(confirm("Shuffle quiz and restart progress?")) {
        const shuffleQs = document.getElementById('jumbleQuestions').checked;
        const shuffleOpts = document.getElementById('jumbleOptions').checked;
        const raw = questions.map((q, idx) => {
          const opts = [...q.options];
          opts[q.answer] = `**${opts[q.answer]}**`;
          return `${idx+1}. ${q.q}\n${opts.map((o, i) => `${String.fromCharCode(65+i)}) ${o}`).join('\n')}`;
        }).join('\n\n');
        processRawText(raw, shuffleQs, shuffleOpts);
      }
    };

    document.getElementById('aiFileInput').onchange = async (e) => {
      const file = e.target.files[0], apiKey = document.getElementById('geminiApiKey').value, count = document.getElementById('numQuestions').value || 200;
      if (!file || !apiKey) { alert("Key and File required."); return; }
      showLoading("Starting...", 5);
      try {
        let text = "";
        if (file.name.endsWith('.pdf')) text = await extractPdfText(file);
        else if (file.name.endsWith('.docx')) text = (await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()})).value;
        showLoading(`Authoring MCQs...`, 40);
        const aiOutput = await callGemini(apiKey, text, count);
        showLoading("Rendering...", 90);
        await processRawText(aiOutput, false, false);
        showLoading("Ready!", 100); setTimeout(hideLoading, 800);
      } catch (err) { alert(err.message); hideLoading(); }
    };

    document.getElementById('fileInput').onchange = (e) => {
      const file = e.target.files[0]; if (!file) return;
      showLoading("Reading...", 50);
      const reader = new FileReader();
      reader.onload = (event) => {
        mammoth.extractRawText({arrayBuffer: event.target.result}).then(async (result) => { 
          await processRawText(result.value, false, false); hideLoading(); 
        });
      };
      reader.readAsArrayBuffer(file);
    };

    document.getElementById('generateBtn').onclick = async () => {
      const text = document.getElementById('pasteInput').value;
      if (!text.trim()) return;
      showLoading("Processing...", 50);
      await processRawText(text, false, false);
      hideLoading();
    };
  </script>
</body>
</html>
